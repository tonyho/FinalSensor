C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\output\main.lst) OBJECT(.\outp
                    -ut\main.obj)

line level    source

   1          #include <reg52.h>
   2          #include <intrins.h>
   3          #include <stdio.h>
   4          #include "MacroAndConst.h"
   5          #include "DS1302DY.h"
   6          #include "LCD1602YT.h"
   7          #include "18B20.h"
   8          #include "key44y.h"
   9          #include "UartPrintf.h"
  10          
  11          sbit LED = P3^3;
  12          sbit BELL = P3^7;
  13          
  14          char i=0; //È«¾Ö°´¼üSubSw±êÖ¾  ×Ó²Ëµ¥°´¼ü9
  15          
  16          char TemF;      // ÎÂ¶ÈµÄ±êÖ¾Î»
  17          //char TimeString[21],TempString[9]; // ·Ö±ðÊÇÊ±¼äºÍÎÂ¶È´¢´æ×Ö·û´®   ÊÇ×Ö·û´®  ´ÓËüÃÇµÄÊýÖµ×ª»»¹ýÀ´  ÔÚCha
             -ngAllValueToString()º¯ÊýÖÐ½øÐÐ 
  18          //char KeyValMain = 0;  //mainº¯ÊýÖÐ4*4¼üÅÌÉ¨ÃèÖµ
  19          
  20          //uint8 DS1302[7] ; //½«DS1302ÖÐµÄÄêÔÂÈÕÊ±·ÖÃë·ÅÈëÊý×éÖÐ  ·½±ãÓëDS1302ChÊý×éµÄ½»Á÷
  21          unsigned char DS1302Ch[7] = {0};
  22          unsigned char DS1302Limit[7] = {99,12,31,23,59,59,7};
  23          
  24          uint8 volatile PageF = 0;
  25          uint8 volatile SubSw = 0;
  26          
  27          int8 TiAH = 8;  //ÄÖÖÓÐ¡Ê±
  28          int8 TiAM = 1;  //ÄÖÖÓ·ÖÖÓ
  29          bit   TAOC = 1; //ÄÖÖÓ¿ª¹Ø±êÖ¾Î»
  30          
  31          
  32          uint8 TeAH = 30; //DS18B20±¨¾¯ÉÏÏÞÎÂ¶ÈµÄÕûÊý²¿·Ö
  33          //uint8 TeAHFloat = 5;   // DS18B20±¨¾¯ÉÏÏÞÎÂ¶ÈµÄÐ¡Êý²¿·Ö
  34          bit TeAHF       = 1;   // ·ûºÅÎ»
  35          
  36          uint8 TeAL = 20;  //DS18B20±¨¾¯ÏÂÏÞÎÂ¶ÈµÄÕûÊý²¿·Ö
  37          //uint8 TeALFloat = 4;
  38          bit TeALF       = 0;
  39          
  40          uint8 YearCh = 10;
  41          uint8 MontCh = 9 ;
  42          
  43          void LCD1602_Display_1302();
  44          void LCD1602_Display_18B20();
  45          void SystemIni( );
  46          void DisplayTempTime( );
  47          void KeyEqu2( ); // ÅÐ¶Ï°´¼üÊÇ·ñÎª2
  48          void KeyEqu9( ); // °´¼ü9 Îª×ÓÑ¡Ïî°´¼ü ¶ÔÓ¦SubSW±äÁ¿
  49          void DisplayTimeAlarm();
  50          void DisplayTempAlarm();
  51          void KeyEqu1_Plus( uint8 i);
  52          void KeyEqu5_Sub(uint8 i);
  53          void SetDs1302Display(uint8 i);
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 2   

  54          //void Bell(void);
  55          void delay1ms();   // Õâ¸öÑÓÊ±º¯Êý²¢²»ÖªµÀ´óÔ¼¶à¾Ã,Ö»ÊÇÓÃÓÚÔÚ¹â±êºÍBellÖÐÉÔÎ¢ÑÓÊ±Ò»ÏÂ°ÕÁË
  56          uint8 KeyData_Plus( uint8 Data );   //¶ÔÓ¦µÄ±äÁ¿¼Ó
  57          uint8 KeyData_Sub ( uint8 Data ); //¶ÔÓ¦µÄ±äÁ¿¼õ
  58          void TimeAlarmBell(); //ÄÖÖÓ·äÃùÆ÷±¨¾¯
  59          void TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
  60          void JudgeMonthDays(void);       // ÉèÖÃÔÂ·ÝµÄ×î¶àÌìÊý
  61          uint8 GetWeekFromDay(unsigned char year,unsigned char month,unsigned char day);//¼ÆËãÈÎÒ»ÌìÊÇÐÇÆÚ¼¸
  62          
  63          /***************************************************************************************************/
  64          void UartService(void)  interrupt 4
  65          {
  66   1               char RecieveBuff = 0;
  67   1              EA = 0;
  68   1              ES = 0;
  69   1         //************************ÓÃÉÏÎ»»ú·¢ËÍÊý¾ÝÊ±ÒªÓÃ16½øÖÆ·¢ËÍ,·ñÔò²»×¼È·***************************//
  70   1                      if(1 == RI)
  71   1                      {
  72   2                              RecieveBuff = SBUF;                             // »º´æ½ÓÊÕµ½µÄÊý¾Ý
  73   2                              RI = 0;                                         // ½ÓÊÕ±êÖ¾ÇåÁã
  74   2                      }
  75   1                      if(RecieveBuff == 0)
  76   1                      {
  77   2                              LED = 0;
  78   2                              BELL = 1;
  79   2                              delay1ms();
  80   2                              delay1ms();
  81   2                              delay1ms();
  82   2                              Uart_Printf("%nGet %d%n",RecieveBuff);
  83   2                      }
  84   1              else    if(RecieveBuff == 1)
  85   1                      {
  86   2                              LED = 0;  
  87   2      
  88   2                              BELL = 0;
  89   2                      
  90   2                              delay1ms();
  91   2                              Uart_Printf("%nGet %d%n",RecieveBuff);
  92   2                      }
  93   1              else    if(RecieveBuff == 2)
  94   1                      {
  95   2                              LED  = 0;  
  96   2      
  97   2                              BELL = 0;
  98   2                              delay1ms();
  99   2                              delay1ms();
 100   2                              delay1ms();
 101   2                              delay1ms();
 102   2                              delay1ms();
 103   2                              delay1ms();
 104   2                              Uart_Printf("%nGet %d%n",RecieveBuff);
 105   2                      }
 106   1      //      else
 107   1              if(RecieveBuff == 'W')    //·¢ËÍÕâ¸öÊ±ÉÏÎ»»úÓÃ×Ö·ûÄ£Ê½(ÓÃ´®¿Úµ÷ÊÔÆ÷Èí¼þ) ·µ»ØµÄÒ²ÊÇW  ×¢ÒâÊÕ·¢¶¼ÊÇ×Ö·ûÄ£Ê½
             -(²»ÒªÑ¡16½øÖÆ)
 108   1                      {
 109   2                              LED = 0;  
 110   2      
 111   2                              BELL = 0;
 112   2                              delay1ms();
 113   2                              delay1ms();
 114   2                              delay1ms();
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 3   

 115   2                                      delay1ms();
 116   2                              delay1ms();
 117   2                              delay1ms();
 118   2                                      delay1ms();
 119   2                              delay1ms();
 120   2                              delay1ms();
 121   2                                      delay1ms();
 122   2                              delay1ms();
 123   2                              delay1ms();
 124   2                              Uart_Printf("%nGet %c%n",RecieveBuff);  
 125   2                      }
 126   1                      BELL = 1;
 127   1      /*
 128   1              if(state == 1)
 129   1                      {
 130   1                              BELL = 0;
 131   1                              LED = 0;
 132   1                              delay1ms();
 133   1                      }
 134   1              if(state == 2)
 135   1              {
 136   1                      BELL = 1;
 137   1                      LED  = 1;
 138   1                      delay1ms();
 139   1              }
 140   1      */      
 141   1              EA = 1;
 142   1              ES = 1;
 143   1              //TR1 = 1;
 144   1      
 145   1      }
 146          
 147          
 148          void main()
 149          {
 150   1         SystemIni( );
 151   1       
 152   1        while(1)
 153   1        {
 154   2              /**********************************
 155   2              while(0 == RI);
 156   2              if(1 == RI)
 157   2                      {
 158   2                              RI = 0;
 159   2                              LED = 0;
 160   2                      }
 161   2           *******************************/
 162   2      
 163   2               Uart_Printf("Hello%n");
*** WARNING C209 IN LINE 163 OF SRC\MAIN.C: '_Uart_Printf': too few actual parameters
 164   2      //      UART_TXDSTRING("Test the Uart is OK !! From Func", 1);
 165   2      //          printf("From Printf");
 166   2      
 167   2      
 168   2                 TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 169   2      //=============================---1---Time Temperature Display==========================================//
             -        
 170   2                  SubSw = 0;
 171   2                while(PageF == 2)
 172   2                {
 173   3                       TimeAlarmBell();//Time Alarm ÄÖÖÓ
 174   3                       TempAlarmBellLed();
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 4   

 175   3      
 176   3                      for( i = 0 ; i<8; i++)  // iÎªSubSw9°´¼üÖµ
 177   3                      {
 178   4                              //Clear1602      // ÇåÆÁ  ÓÃÓÚÏûÈ¥ÄÖÖÓ±êÖ¾ÔÚÃ»ÓÐÖ¸¶¨µÄÎ»ÖÃ¶àÏÔÊ¾
 179   4      
 180   4                              TimeAlarmBell();
 181   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 182   4                      
 183   4                              if(1 == SubSw)          DS1302Ch[0] = ReadYs();
 184   4                              if(2 == SubSw)          DS1302Ch[1] = ReadMn();
 185   4                              if(3 == SubSw)          DS1302Ch[2] = ReadDay();
 186   4                              if(4 == SubSw)          DS1302Ch[3] = ReadHr();
 187   4                              if(5 == SubSw)          DS1302Ch[4] = ReadMin();
 188   4                              if(6 == SubSw)          DS1302Ch[5] = ReadSec();
 189   4                              if(7 == SubSw)          DS1302Ch[6] = ReadWe();
 190   4                       
 191   4                              if(2 != PageF)  break;
 192   4      
 193   4                              while(i == SubSw)
 194   4                          {
 195   5      
 196   5                                      if(SubSw == 0)  break; 
 197   5      
 198   5                                      SetDs1302Display(SubSw);
 199   5      
 200   5                                      if(0 == DS1302Ch[6])  //·ÀÖ¹ÐÇÆÚ³öÏÖ0  ÐÇÆÚÎªunsigned char ÐÍ  ÔÚSetDs1302Display()º¯ÊýÖÐ¼Ó¼õÊ±ÄÜ³öÏÖ0
 201   5                                              DS1302Ch[6] = 1;
 202   5                                      
 203   5                                      if(0 == DS1302Ch[1])  //·ÀÖ¹ÔÂ·Ý³öÏÖ0  ÔÂ·ÝÎªunsigned char ÐÍ  ÔÚSetDs1302Display()º¯ÊýÖÐ¼Ó¼õÊ±ÄÜ³öÏÖ0
 204   5                                              DS1302Ch[1] = 1;
 205   5      
 206   5      
 207   5      //******************ÔÚÏÂÃæÕâ¶Î±ß½çÅÐ¶ÏÖÐ ÓÃµ½ÁËDS1302Ch[]Êý×é Òò´ËÔÚÕâÖ®Ç°ÐèÒªÏÈË¢ÐÂÒ»±éÕâ¸öÊý×é**********
             -******************//
 208   5      //*****************¾ßÌåº¯ÊýÔÚSystemIni()ÏµÍ³³õÊ¼»¯º¯ÊýÖÐ(       DS1302Ch[0] = ReadYs();...Óï¾ä)*****************
             -****************//
 209   5                                      JudgeMonthDays(); 
 210   5                                      if(DS1302Ch[i-1] > DS1302Limit[i-1])    // ·ÀÖ¹µ÷½ÚÊ±¼äÊ±¹ý½ç  Èçµ÷Ð¡Ê±Ê± ´óÓÚ24
 211   5                                      {
 212   6                                              DS1302Ch[i-1] = DS1302Limit[i-1]; 
 213   6                                      }
 214   5                              
 215   5                                      if(0 == DS1302Ch[i-1] && KeyScanValue()==5)      //
 216   5                                      {
 217   6                                              DS1302Ch[i-1] = DS1302Limit[i-1];
 218   6                                      }
 219   5                                      if(1 == DS1302Ch[1]&& KeyScanValue()==5)
 220   5                                              DS1302Ch[1] = 12;
 221   5                                                      
 222   5                                      if(DS1302Limit[i-1] == DS1302Ch[i-1] && KeyScanValue()==1)
 223   5                                      {
 224   6                                              if( 1 != i) DS1302Ch[i-1] = 0;  // ÐÇÆÚ´Ó1¿ªÊ¼ ¶ø·Ç0
 225   6                                              else 
 226   6                                                      DS1302Ch[i-1] = 1;
 227   6                                      }
 228   5      
 229   5                                      if(1 == i)      
 230   5                                      {
 231   6                                              WriteYs (DS1302Ch[0]);  WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 232   6                                      }
 233   5                                      if(2 == i)
 234   5                                      {
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 5   

 235   6                                              WriteMn (DS1302Ch[1]); WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 236   6                                      }
 237   5                                      if(3 == i)
 238   5                                      {
 239   6                                              WriteDay(DS1302Ch[2]);  WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 240   6                                      }
 241   5                                      if(4 == i)
 242   5                                      {
 243   6                                              WriteHr (DS1302Ch[3]);WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 244   6                                      }
 245   5                                      if(5 == i)
 246   5                                      {
 247   6                                              WriteMin(DS1302Ch[4]);WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 248   6                                      }
 249   5      
 250   5                                      if(6 == i)
 251   5                                      {
 252   6                                              WriteSec(DS1302Ch[5]);WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ 
 253   6                                      }
 254   5                                      if(7 == i)
 255   5                                      { 
 256   6                                       WriteWe( GetWeekFromDay(ReadYs(), ReadMn(), ReadDay()) );   //×Ô¶¯ÉèÖÃÐÇÆÚ  ×¢ÒâÕâÌõÓï¾äÊÇÔÚ 7==i µÄÌ
             -õ¼þÏÂ²ÅÔËÐÐ
 257   6                                                                                                                                                               //ËùÓÐÖ»ÓÐ°´9¼ü(Ê¹SubSw==7)Ê¹i==7,²ÅÂú×ãwhile(i==SubSw)²ÅÔËÐÐ
 258   6                                                                                                                                                               //Òò´ËÐèÒª°´9¼ü ÈÃ¹â±êÌøµ½ÐÇÆÚÎ»ÖÃ ²Å»á×Ô¶¯ÉèÖÃ
 259   6                                      //      WriteWe (DS1302Ch[6]);
 260   6                                      }
 261   5                      
 262   5                                      if(0 == SubSw)                  
 263   5                                      {
 264   6                                        TimeAlarmBell();
 265   6                                        TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 266   6                                        WriteC( NOFlashCur1602 , 1 );
 267   6                                
 268   6                                        DisplayTempTime( );
 269   6                                        KeyEqu9( );
 270   6                                      }
 271   5      
 272   5                      /**************ÕâÁ½¾ä½ö½öÊÇÓÃÓÚÈÃ¹â±êÏÔÊ¾ÇåÎú***ÏÂÃæµÄÒ²Ò»Ñù****************/             
 273   5                                        delay1ms();
 274   5                                        WriteC( NOFlashCur1602 , 1 );
 275   5                      /***************************************************************************/
 276   5                                  DisplayTempTime( );
 277   5                                  KeyEqu9( ); 
 278   5                                  KeyEqu2( );
 279   5                                      if(2 != PageF)  break;  
 280   5                              }
 281   4      
 282   4                              while(0 == SubSw)
 283   4                              {
 284   5                                      TimeAlarmBell();
 285   5              
 286   5                                      DisplayTempTime( );
 287   5                                  KeyEqu9( ); 
 288   5                                  KeyEqu2( );
 289   5                                      if(2 != PageF)  break;
 290   5                              }
 291   4      
 292   4                       }
 293   3      
 294   3                              KeyEqu9( );
 295   3                              if(PageF != 2)  break;
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 6   

 296   3                      }
 297   2      //===============================---2--Time Alarm Set============================================// 
 298   2                //LCDRst();
 299   2                      Clear1602        // ÇåÆÁ  ÓÃÓÚÏûÈ¥ÄÖÖÓ±êÖ¾ÔÚÃ»ÓÐÖ¸¶¨µÄÎ»ÖÃ¶àÏÔÊ¾
 300   2                SubSw = 0;
 301   2                 while(PageF == 1)
 302   2                {
 303   3                        TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 304   3                      while(0 == SubSw)
 305   3                      {
 306   4                              KeyEqu9( );
 307   4                              KeyEqu2( );
 308   4                              DisplayTimeAlarm();
 309   4                              if(PageF != 1)  break;          
 310   4                      }
 311   3              /************************************************************/
 312   3                      while(1 == SubSw)
 313   3                      {
 314   4                              
 315   4                              LcdSetXY(0,1);
 316   4                              WriteC( FlashCur1602 , 1 );
 317   4      
 318   4                          if( KeyScanValue()==5||KeyScanValue()==1)
 319   4                                      TAOC = ~TAOC;
 320   4                                      /***********************************/
 321   4                                      delay1ms();
 322   4                                      WriteC( NOFlashCur1602 , 1 );
 323   4                                      
 324   4                               DisplayTimeAlarm();
 325   4      
 326   4                              KeyEqu9( );
 327   4                              KeyEqu2( );
 328   4                              if(PageF != 1)  break;  
 329   4                      }
 330   3                      WriteC( NOFlashCur1602 , 1 );
 331   3      
 332   3                      while(2 == SubSw)
 333   3                      {
 334   4                              LcdSetXY(4,1);
 335   4                              WriteC( FlashCur1602 , 1 );
 336   4                              
 337   4                              TiAH = KeyData_Plus( TiAH );
 338   4                              TiAH = KeyData_Sub ( TiAH );
 339   4                              if(TiAH > 23) 
 340   4                                      TiAH = 0;
 341   4                              if(TiAH < 0)
 342   4                                      TiAH = 23;
 343   4                      
 344   4                              delay1ms();
 345   4                              WriteC( NOFlashCur1602 , 1 );
 346   4      
 347   4                          DisplayTimeAlarm();
 348   4      
 349   4                              KeyEqu9( );
 350   4                              KeyEqu2( );
 351   4                              if(PageF != 1)
 352   4                              break;  
 353   4                      }
 354   3                      while(3 == SubSw)
 355   3                      {
 356   4                              LcdSetXY(7,1);
 357   4                              WriteC( FlashCur1602 , 1 );
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 7   

 358   4                              
 359   4                              TiAM = KeyData_Plus( TiAM );
 360   4                              TiAM = KeyData_Sub ( TiAM );
 361   4                               
 362   4                               if(TiAM > 59) 
 363   4                                      TiAM = 0;
 364   4                               if(TiAM < 0)
 365   4                                  TiAM = 59;
 366   4                          delay1ms();
 367   4                                      WriteC( NOFlashCur1602 , 1 );
 368   4      
 369   4                              DisplayTimeAlarm();
 370   4      
 371   4                              KeyEqu9( );
 372   4                              KeyEqu2( );
 373   4                              if(PageF != 1)
 374   4                              break;  
 375   4                      }
 376   3      
 377   3                      if(4 == SubSw)//ÕâÁ½ÌõÓï¾äµÄ×÷ÓÃÊÇ½â¾öÔÚÕâÀï°´»»ÆÁ¼ü(2¼ü,¶ÔÓ¦±äÁ¿ÎªPageF)ÎÞÐ§
 378   3                              break;  
 379   3              //ÉÏÃæµÄÁ½ÐÐÓëÏÂÃæµÄKeyEqu2()º¯ÊýÊÇÒ»ÑùµÄ       
 380   3                      //KeyEqu2( );
 381   3                      KeyEqu9( );
 382   3              
 383   3                      if(PageF != 1)
 384   3                              break;
 385   3                }
 386   2      
 387   2      //===============================---3--Temperature Alarm Set============================================//
             - 
 388   2                  LCDRst();
 389   2                  SubSw = 0;
 390   2                      //TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 391   2                while(PageF == 0)
 392   2                {
 393   3                      TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 394   3                      while(0 == SubSw)
 395   3                      {
 396   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 397   4                              KeyEqu9( );             
 398   4                              DisplayTempAlarm();     
 399   4                              KeyEqu2( );
 400   4                              if(PageF != 0)
 401   4                                      break;
 402   4                              break;          
 403   4                      }
 404   3      
 405   3                while(1 == SubSw)
 406   3                      {       
 407   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý             
 408   4                              LcdSetXY(3,1);
 409   4                              WriteC( FlashCur1602 , 1 );
 410   4                              
 411   4                          if( KeyScanValue()==5||KeyScanValue()==1)
 412   4                                      TeALF = ~TeALF;
 413   4                        
 414   4                          delay1ms();
 415   4                              WriteC( NOFlashCur1602 , 1 );
 416   4                      
 417   4                              DisplayTempAlarm();     
 418   4      
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 8   

 419   4                              KeyEqu9( );     
 420   4                              
 421   4                              KeyEqu2( );
 422   4                              if(PageF != 0)
 423   4                                      break;
 424   4                              
 425   4                      }
 426   3      
 427   3                              while(2 == SubSw)
 428   3                      {       
 429   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý                     
 430   4                              LcdSetXY(5,1);
 431   4                              WriteC( FlashCur1602 , 1 );
 432   4                              
 433   4                          TeAL = KeyData_Plus( TeAL );
 434   4                              TeAL = KeyData_Sub ( TeAL );
 435   4                        
 436   4                          delay1ms();
 437   4                              WriteC( NOFlashCur1602 , 1 );
 438   4                      
 439   4                              DisplayTempAlarm();     
 440   4      
 441   4                              KeyEqu9( );     
 442   4                              
 443   4                              KeyEqu2( );
 444   4                              if(PageF != 0)
 445   4                                      break;
 446   4                              
 447   4                      }
 448   3                       
 449   3                              while(3 == SubSw)
 450   3                      {
 451   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý
 452   4                              LcdSetXY(11,1);
 453   4                              WriteC( FlashCur1602 , 1 );
 454   4                              
 455   4                          if( KeyScanValue()==5||KeyScanValue()==1)
 456   4                                      TeAHF = ~TeAHF;
 457   4                        
 458   4                          delay1ms();
 459   4                              WriteC( NOFlashCur1602 , 1 );
 460   4                      
 461   4                              DisplayTempAlarm();     
 462   4      
 463   4                              KeyEqu9( );     
 464   4                              KeyEqu2( );
 465   4                              if(PageF != 0)
 466   4                                      break;
 467   4                              
 468   4                      }
 469   3      
 470   3                              while(4 == SubSw)
 471   3                      {       
 472   4                              TempAlarmBellLed(); // ÎÂ¶È±¨¾¯º¯Êý                     
 473   4                              LcdSetXY(13,1);
 474   4                              WriteC( FlashCur1602 , 1 );
 475   4                              
 476   4                          TeAH = KeyData_Plus( TeAH );
 477   4                              TeAH = KeyData_Sub ( TeAH );
 478   4                        
 479   4                          delay1ms();
 480   4                              WriteC( NOFlashCur1602 , 1 );
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 9   

 481   4                      
 482   4                              DisplayTempAlarm();     
 483   4      
 484   4                              KeyEqu9( );     
 485   4                              
 486   4                              KeyEqu2( );
 487   4                              if(PageF != 0)
 488   4                                      break;
 489   4                              
 490   4                      }
 491   3                      if(SubSw == 5)
 492   3                              break;  
 493   3              //      KeyEqu2( );             
 494   3                      if(PageF != 0)
 495   3                              break;
 496   3                }
 497   2               
 498   2              
 499   2        }
 500   1      }
 501          
 502          
 503          
 504          
 505          void SystemIni(void)
 506          {
 507   1              LCDRst();
 508   1              DS1308_init();   // Ó²¼þÉè¼ÆÉÏ´æÔÚÊ§Îó:  Ã»ÓÐ¼ÓÉÏÀ­µç×è  ËùÒÔÈç¹û²»¸øÐ´ÈëÄÇÃ´»á³öÏÖ85Õâ¸öÖµ
 509   1              DS1302Ch[0] = ReadYs ();
 510   1              DS1302Ch[1] = ReadMn ();
 511   1              DS1302Ch[2] = ReadDay();
 512   1              DS1302Ch[3] = ReadHr ();
 513   1              DS1302Ch[4] = ReadMin();
 514   1              DS1302Ch[5] = ReadSec();
 515   1              DS1302Ch[6] = ReadWe ();
 516   1      
 517   1              LCDRst();
 518   1      
 519   1      //      DS1302_Write_Ini_Data(10,12,31,23,59,55,2); //ÒòÎªÒÑ¾­½«Ð´ÈëºÍ¶Á³öµÄÖµ¾ù×ª»»³ÉBCDÂë  ËùÒÔÖ±½Ó¸ø10½øÖÆµÄ
             -Êý¾Í¿ÉÒÔÁË
 520   1      
 521   1              // ÏÂÃæÈÃ18B20×ª»»2´Î µÚÒ»¸öget_temperatureÊÇ¶Á³öÄ¬ÈÏµÄ+85 
 522   1              // µÚ¶þ¸öÊÇDS18B20Íê³ÉµÚÒ»´Î×ª»»,¸üÐÂÎÂ¶ÈÖµ,
 523   1              // ±ÜÃâÎÂ¶È±¨¾¯µÄµÚÒ»´ÎÅÐ¶Ï´íÎó(¼´TempAlarmBellLedº¯ÊýµÚÒ»´ÎÅÐ¶Ï)
 524   1              get_temperature();
 525   1              get_temperature();
 526   1              
 527   1              Uart_Init(4800);
 528   1      }
 529          
 530          void LCD1602_Display_1302()
 531          {
 532   1       
 533   1              DisC(0,0,ys/10+'0');
 534   1              DisC(1,0,ys%10+'0');
 535   1              
 536   1              DisC(3,0,mn/10+'0');
 537   1              DisC(4,0,mn%10+'0');
 538   1              
 539   1              DisC(6,0,day/10+'0');  
 540   1              DisC(7,0,day%10+'0');
 541   1              
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 10  

 542   1              DisC(0,1,hr/10+'0');
 543   1              DisC(1,1,hr%10+'0');
 544   1      
 545   1                      DisC(2,1,':');
 546   1      
 547   1              DisC(3,1,min/10+'0');
 548   1              DisC(4,1,min%10+'0');
 549   1                      
 550   1                      DisC(5,1,':');
 551   1              
 552   1              
 553   1              DisC(6,1,sec/10+'0');
 554   1              DisC(7,1,sec%10+'0');
 555   1      
 556   1              DisS(10,1,"Week:");             
 557   1              DisC(15,1,we+'0');
 558   1              
 559   1      }
 560          
 561          
 562          
 563          void LCD1602_Display_18B20()
 564          {
 565   1              if(1 == f)  TemF = '-';
 566   1              if(0 == f)  TemF = '+'; 
 567   1      
 568   1              DisC(10,0,TemF);
 569   1              DisC(11,0,tempint/10+'0');
 570   1              DisC(12,0,tempint%10+'0');
 571   1              DisC(13,0,'.');
 572   1      
 573   1              tempdf = (tempdf * 5 / 8); // ½«ÎÂ¶ÈµÄÐ¡Êý²¿·ÖµÄ0.00~0.15×ª»»µ½0.0~0.9  
 574   1              DisC(14,0,tempdf+'0');
 575   1      }
 576          
 577          void DisplayTempTime(void)      // PageF == 0  Ê±ÏÔÊ¾Ê±¼äºÍÎÂ¶È
 578          {
 579   1      
 580   1      //      Clear1602 
 581   1      //      delay1ms();
 582   1        /************************ÏÂÃæÊÇ×Ô¶¨Òå×Ö·û ´æÔÚÎÊÌâ**************************************/
 583   1          v_LcdWriteSelfFont_f( );
 584   1      
 585   1                      LcdSetXY( 2,0 );  // ×Ô¶¨Òå×Ö·ûÒªÔÚ1602ÏÔÊ¾ÆäËû¶«Î÷µÄ×îÇ°Ãæ
 586   1              v_LcdDisplaySelfFont_f( 0 );       //Äê
 587   1                      LcdSetXY( 5,0 );
 588   1              v_LcdDisplaySelfFont_f( 1 );      // ÔÂ
 589   1                      LcdSetXY( 8,0 );
 590   1              v_LcdDisplaySelfFont_f( 2 );      // ÈÕ
 591   1              
 592   1              if(TAOC)
 593   1                      LcdSetXY( 8,1 );
 594   1              v_LcdDisplaySelfFont_f( 3 );      //
 595   1                      LcdSetXY( 15,0 );
 596   1              v_LcdDisplaySelfFont_f( 4 );      //ÎÂ¶È±êÖ¾¡æ  
 597   1      
 598   1                      read_DS1308();
 599   1              LCD1602_Display_1302();
 600   1      
 601   1              get_temperature();
 602   1              LCD1602_Display_18B20();
 603   1      
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 11  

 604   1      }
 605          
 606          
 607           void KeyEqu2( void )
 608           {
 609   1               if( KeyScanValue()==2)
 610   1        {
 611   2                PageF++;        
 612   2        }
 613   1               if(PageF == 3)
 614   1               {
 615   2                      PageF = 0;
 616   2               }
 617   1       }
 618          
 619          
 620           void KeyEqu9( void )
 621           {
 622   1               if( KeyScanValue()==9)
 623   1        {
 624   2               SubSw++;
 625   2        }
 626   1        if(SubSw == 8)
 627   1               {
 628   2                      SubSw = 0;
 629   2               }
 630   1              
 631   1       }
 632          
 633          void KeyEqu1_Plus( uint8 SubSw )   //¶ÔÓ¦µÄÊ±¼ä¼Ó
 634           {
 635   1               if( KeyScanValue()==1)
 636   1        {
 637   2               (DS1302Ch[SubSw-1])++;
 638   2        }
 639   1      //  if( DS1302Ch[i] == DS1302Limit[i])
 640   1      //       {
 641   1      //              DS1302Ch[i] = 0;
 642   1      //       }
 643   1              
 644   1       }
 645          
 646           
 647          void KeyEqu5_Sub( uint8 SubSw )  //¶ÔÓ¦µÄÊ±¼ä¼õ
 648           {
 649   1               if( KeyScanValue()==5)
 650   1        {
 651   2               (DS1302Ch[SubSw-1])--;
 652   2        }
 653   1       // if(YearCh == 0)
 654   1      //       {
 655   1      //              YearCh = 0x20;
 656   1      //       }
 657   1              
 658   1       }
 659          
 660          uint8 KeyData_Plus( uint8 Data )   //¶ÔÓ¦µÄ±äÁ¿¼Ó
 661           {
 662   1               if( KeyScanValue()==1)
 663   1        {
 664   2               ++Data;
 665   2        }
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 12  

 666   1      
 667   1               return Data;
 668   1       }
 669          
 670           
 671          uint8 KeyData_Sub( uint8 Data )  //¶ÔÓ¦µÄ±äÁ¿¼õ
 672           {
 673   1               if( KeyScanValue()==5)
 674   1        {
 675   2               --Data;
 676   2        }
 677   1               return Data;
 678   1       }
 679          
 680           void DisplayTimeAlarm()
 681           {
 682   1              
 683   1                DisS(0,0,"1--TimeAlarm:");
 684   1      
 685   1      //        DisC(0,1,(char)(TAOC) +'0');
 686   1                
 687   1                if(TAOC)
 688   1                {
 689   2                      LcdSetXY(0,1);
 690   2                      v_LcdDisplaySelfFont_f( 3 );
 691   2                }
 692   1                else
 693   1                {
 694   2                      //LcdSetXY(0,1);
 695   2                      DisC(0,1,'C');
 696   2                }
 697   1      
 698   1                DisC(3,1,TiAH/10+'0');
 699   1                DisC(4,1,TiAH%10+'0');
 700   1      
 701   1                DisC(5,1,':');
 702   1      
 703   1                DisC(6,1,TiAM/10+'0');
 704   1                DisC(7,1,TiAM%10+'0');
 705   1      
 706   1       }
 707          
 708           
 709           void DisplayTempAlarm()
 710           {
 711   1              
 712   1                DisS(0,0,"2--TempLimit:");
 713   1      
 714   1                DisC(0,1,'L');
 715   1                DisC(1,1,':');
 716   1                DisC(3,1, ((char)(TeALF)==0)?'-':'+');
 717   1      
 718   1                DisC(4,1,TeAL/10+'0');
 719   1                DisC(5,1,TeAL%10+'0');
 720   1      //        DisC(4,1,'.');
 721   1      //        DisC(5,1,TeALFloat);
 722   1      //        DisC(6,1,'C');
 723   1                      LcdSetXY( 6,1 );
 724   1              v_LcdDisplaySelfFont_f( 4 );      //ÎÂ¶È±êÖ¾¡æ
 725   1      
 726   1                
 727   1      
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 13  

 728   1                DisC(8,1,'H');
 729   1                DisC(9,1,':');
 730   1                DisC(11,1, ((char)(TeAHF)==0)?'-':'+');
 731   1      
 732   1                DisC(12,1,TeAH/10+'0');
 733   1                DisC(13,1,TeAH%10+'0');
 734   1      //        DisC(12,1,'.');
 735   1      //        DisC(13,1,TeAHFloat);
 736   1      //        DisC(14,1,'C');
 737   1                      LcdSetXY( 14,1 );
 738   1              v_LcdDisplaySelfFont_f( 4 );      //ÎÂ¶È±êÖ¾¡æ
 739   1      
 740   1       }
 741          
 742          
 743          void SetDs1302Display(uint8 i)
 744          {
 745   1      
 746   1      
 747   1              KeyEqu1_Plus( i );
 748   1              KeyEqu5_Sub(  i );
 749   1              
 750   1      
 751   1              if(1 == SubSw)
 752   1                      LcdSetXY(1, 0);
 753   1              if( SubSw==3 || SubSw==2 )
 754   1              {
 755   2                      LcdSetXY(SubSw+SubSw+SubSw-2,0);  // 3*i-2
 756   2              }
 757   1      
 758   1              if(4 == SubSw)
 759   1                      LcdSetXY(1, 1);
 760   1              if( SubSw==5 || SubSw==6 )
 761   1              {
 762   2                      LcdSetXY( SubSw+SubSw+SubSw-11,1);  // 3*i-2
 763   2              }
 764   1              if(7==SubSw)
 765   1              {
 766   2                      LcdSetXY(15,1);
 767   2              }
 768   1               WriteC( FlashCur1602 , 1 );
 769   1      }
 770          
 771          void delay1ms()
 772          {
 773   1              unsigned char i,j;
 774   1              for(i=0; i<100; i++)
 775   1                      for(j=0; j<100; j++);
 776   1      }
 777          
 778          /*
 779          void Bell(void)  
 780          {
 781                  BELL = 0;
 782                  delay1ms();
 783                  BELL = 1;
 784          }
 785          */
 786          
 787          
 788          void TimeAlarmBell()
 789          {
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 14  

 790   1              while( TAOC )
 791   1               {
 792   2                      if(min == TiAM &&  hr== TiAH)    // min,hr
 793   2                      {
 794   3      //                      BELL = 0;
 795   3                              break;
 796   3                      }
 797   2                      else 
 798   2                      {
 799   3                              BELL  = 1;
 800   3                              break;
 801   3                      }
 802   2               }
 803   1      }
 804          
 805          
 806          
 807          void TempAlarmBellLed() // ÎÂ¶È±¨¾¯º¯Êý
 808          {
 809   1       
 810   1                //ÏÂÃæµÄËÄ¸öÅÐ¶Ï ÎªÉÏÏÂ¶Ô³ÆÁ½×é µÚÒ»ÐÐÊÇÕýµÄÎÂ¶ÈÅÐ¶Ï(±êÖ¾Î»==1)  µÚ¶þÐÐÊÇ¸ºÎÂ¶ÈµÄÅÐ¶Ï(±êÖ¾Î»==0)//  
 811   1                      if(      (( (~f == TeAHF) && (TeAHF == 1) ) && (tempint >= TeAH) ) 
 812   1                          || (( ( ~f == TeALF) && (TeALF == 1) ) && (tempint <= TeAL) ) 
 813   1                      ||      (( ( ~f ==TeAHF ) && (TeAHF == 0) ) && (tempint <= TeAH) )  
 814   1                      || (  ( ~f == TeALF && ( TeALF == 0) ) && (tempint >= TeAL) ) )
 815   1                      {
 816   2                      //      BELL = 0;
 817   2                              LED  = 0;
 818   2              
 819   2                      }
 820   1                      else 
 821   1                      {
 822   2                      //      BELL  = 1;
 823   2                              LED   = 1;
 824   2                      }
 825   1               
 826   1      }
 827          
 828          void JudgeMonthDays()  // ÉèÖÃÔÂ·ÝµÄ×î¶àÌìÊý
 829          {
 830   1              if(3 == i)   //Èç¹ûÊÇDay  ÄÇÃ´µÃÇø·ÖÊÇ30 »¹ÊÇ31 Èç¹ûÊÇ¶þÔÂÄÇÃ´»¹Ó¦¸ÃÅÐ¶ÏÊÇÆ½Äê(28 days)»¹ÊÇÈòÄê(29 days)
 831   1                                                                   //if((year%4==0&&year%100!=0)||(year%400==0)) {ÄÇÃ´ÊÇÈòÄê}   
 832   1                                              {
 833   2                                                      if(2 == ReadMn()) // Èç¹ûÊÇ¶þÔÂ
 834   2                                                      {
 835   3                                                              if( !(ReadYs()%4) )       //¶ÁÈ¡Äê·Ý Èç¹ûÊÇÈòÄê  ÕâÀïÃ»ÅÐ¶Ï%100!=0 µ«ÊÇÔÚ20XXÄêÕâ¸öÌõ¼þ¾Í¹»ÁË
 836   3                                                                      DS1302Limit[2] = 29;  
 837   3                                                              else 
 838   3                                                                      DS1302Limit[2] = 28;  
 839   3                                                      }
 840   2                                                      else // Èç¹û²»ÊÇ¶þÔÂ
 841   2                                                              {
 842   3                                                                      if(4 == ReadMn() || 6 == ReadMn() || 9 == ReadMn() || 11 == ReadMn())  // Èç¹ûÔÂ·ÝÊÇ 4 6 9 11 ÄÇÃ´
             -ÊÇ30days
 843   3                                                                              DS1302Limit[2] = 30;
 844   3                                                                      else 
 845   3                                                                              DS1302Limit[2] = 31;    //Ê£ÏÂµÄÔÂ·ÝÊÇ31days
 846   3                                                              }
 847   2                                               }
 848   1      }
 849          
 850          // ¼ÆËã2000¡«2099ÄêÈÎÒ»ÌìÐÇÆÚ¼¸
C51 COMPILER V9.00   MAIN                                                                  10/09/2010 00:00:16 PAGE 15  

 851          // year    : 00-99
 852          // month: 01-12
 853          // day     : 01-31
 854          uint8 GetWeekFromDay(unsigned char year,unsigned char month,unsigned char day)
 855          {
 856   1          if( month == 1 || month == 2 )  
 857   1          {
 858   2              month += 12;
 859   2              if( year> 0 )
 860   2                  year--;
 861   2              else
 862   2                  year = 4;
 863   2          }
 864   1      
 865   1          // ·µ»ØÐÇÆÚ¼¸(ÐÇÆÚÒ»ÓÃ1±íÊ¾£¬¶øÐÇÆÚÌìÓÃ7±íÊ¾)
 866   1          return 1+(( day + 2*month + 3*(month+1)/5 + year + year/4 ) %7);
 867   1      }  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2619    ----
   CONSTANT SIZE    =     64    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
